<?php
/**
 * Joomcck by joomcoder
 * a component for Joomla! 1.7 - 2.5 CMS (http://www.joomla.org)
 * Author Website: https://www.joomcoder.com/
 * @copyright Copyright (C) 2012 joomcoder (https://www.joomcoder.com). All rights reserved.
 * @license   GNU/GPL http://www.gnu.org/copyleft/gpl.html
 */

defined('_JEXEC') or die();
jimport('mint.mvc.model.admin');

class JoomcckModelTfield extends MModelAdmin
{
	public function __construct($config = array())
	{
		$this->option = 'com_joomcck';
		parent::__construct($config);
	}

	public function populateState($ordering = NULL, $direction = NULL)
	{
		$app = \Joomla\CMS\Factory::getApplication('administrator');

		$type = $app->getUserStateFromRequest('com_joomcck.tfields.filter.type', 'type_id', 0, 'int');
		$this->setState('filter.type', $type);

		parent::populateState($ordering = NULL, $direction = NULL);
	}

	public function getTable($type = 'Field', $prefix = 'JoomcckTable', $config = array())
	{
		return \Joomla\CMS\Table\Table::getInstance($type, $prefix, $config);
	}

	public function save($data)
	{

		return parent::save($data); // TODO: Change the autogenerated stub
	}

	public function getFieldForm($field_type, $default = array())
	{
		$file = JPATH_ROOT . '/components/com_joomcck/fields' . DIRECTORY_SEPARATOR . $field_type . DIRECTORY_SEPARATOR . $field_type . '.xml';
		if(!is_file($file))
		{
			echo "File not found: {$file}";
		}

		FieldHelper::loadLang($field_type);

		$form = new \Joomla\CMS\Form\Form('params', array(
			'control' => 'params'
		));

		$form->loadFile($file, TRUE, 'config');

		return MFormHelper::renderGroup($form, $default, 'params');
	}

	public function getForm($data = array(), $loadData = TRUE)
	{
		$app = \Joomla\CMS\Factory::getApplication();

		$form = $this->loadForm('com_joomcck.tfield', 'field', array(
			'control'   => 'jform',
			'load_data' => $loadData
		));
		if(empty($form))
		{
			return FALSE;
		}

		return $form;
	}

	protected function loadFormData()
	{
		$data = \Joomla\CMS\Factory::getApplication()->getUserState('com_joomcck.edit.tfield.data', array());

		if(empty($data))
		{
			$data = $this->getItem();
		}

		return $data;
	}

	public function getItem($pk = NULL)
	{
		if($item = parent::getItem($pk))
		{
			//print_r($item->params);


			if(!is_array($item->params))
			{
				//echo $item->params;
				$registry = new \Joomla\Registry\Registry();
				$registry->loadString((string)$item->params);
				$item->params = $registry->toArray();
			}
		}

		if(\Joomla\CMS\Factory::getApplication()->input->getInt('group'))
		{
			$item->group_id = \Joomla\CMS\Factory::getApplication()->input->getInt('group');
		}

		return $item;
	}

	protected function getReorderConditions($table)
	{
		return array('group_id = ' . $table->group_id, 'type_id = ' . $table->type_id);
	}

	protected function canDelete($record)
	{
		$user = \Joomla\CMS\Factory::getApplication()->getIdentity();

		return $user->authorise('core.delete', 'com_joomcck.tfield.' . (int)$record->id);
	}

	protected function canEditState($record)
	{
		$user = \Joomla\CMS\Factory::getApplication()->getIdentity();

		return $user->authorise('core.edit.state', 'com_joomcck.tfield.' . (int)$record->id);
	}

	public function changeState($task, &$pks, $value = 1)
	{
		$dispatcher = \Joomla\CMS\Factory::getApplication();
		$user       = \Joomla\CMS\Factory::getApplication()->getIdentity();
		$table      = $this->getTable();
		$pks        = (array)$pks;


		// Access checks.
		foreach($pks as $i => $pk)
		{
			$table->reset();

			if($table->load($pk))
			{
				if(!$this->canEditState($table))
				{
					// Prune items that you can't change.
					unset($pks[$i]);
					\Joomla\CMS\Log\Log::add(\Joomla\CMS\Language\Text::_('JLIB_APPLICATION_ERROR_EDITSTATE_NOT_PERMITTED'), \Joomla\CMS\Log\Log::WARNING, 'jerror');

					return FALSE;
				}
			}
		}

		$params = new \Joomla\Registry\Registry($table->params);
		$param  = str_replace('not', '', $task);
		$params->set('core.' . $param, $value);

		$table->params = $params->toString();
		$table->store();

		// Clear the component's cache
		$this->cleanCache();

		return TRUE;
	}
}